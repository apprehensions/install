# - UNIVERSAL -----------

mkfs_part() {
  	mkfs.btrfs -L root -f $ROOT
	mount -o $BTRFS_OPTS $ROOT /mnt
	btrfs subvolume create /mnt/@
	btrfs subvolume set-default /mnt/@
	umount /mnt
	mount -o $BTRFS_OPTS,subvol=@ $ROOT /mnt
}

mkfs_esp() {
  	mkfs.vfat -nBOOP -F32 $ESP
	mkdir /mnt/$ESPDIR	
	mount -o rw,noatime $ESP /mnt/$ESPDIR
}

iwd_do(){
	mkdir -pv /mnt/etc/iwd
	cat <<EOF > /mnt/etc/iwd/main.conf
[General]
EnableNetworkConfiguration=true
UseDefaultInterface=true
	
[Network]
EnableIPv6=true
EOF
}

blacklist_pc(){echo "blacklist i2c_nvidia_gpu\nblacklist iTCO_wdt" > /etc/modprobe.d/blacklist.conf }
blacklist_laptop(){
	sed -i '7s/()/(i915)/' /etc/mkinitcpio.conf
	echo "options i915 enable_guc=3 enable_fbc=1" > /etc/modprobe.d/i915.conf
	mkinitcpio -P
}

openrc_autologin(){sed -i "agetty_options=/s/\"$/ --autologin wael --noclear&/" /etc/conf.d/agetty.tty1}

# - CHROOT 
grub_install(){
	grub-install --target=x86_64-efi --efi-directory=/efi --bootloader-id='Linux'
	sed -i "/GRUB_CMDLINE_LINUX_DEFAULT=/s/\"$/ nowatchdog loglevel=5&/" /etc/default/grub
	echo -e "\nGRUB_DISABLE_OS_PROBER=false" >> /etc/default/grub
	grub-mkconfig -o /boot/grub/grub.cfg
}

# - ARCH-BASED ----------
hosts_do(){
	echo "127.0.0.1 localhost" >> /mnt/etc/hosts
	echo "::1       localhost" >> /mnt/etc/hosts 
	echo "127.0.1.1 $HOSTNAME.localdomain $HOSTNAME" >> /mnt/etc/hosts
}

# - CHROOT LINE
arch_needed() {
	echo "LANG=en_US.UTF-8" > /etc/locale.conf
	echo "en_US.UTF-8 UTF-8" > /etc/locale.gen
	echo $HOSTNAME > /etc/hostname
	ln -sf /usr/share/zoneinfo/Asia/Riyadh /etc/localtime
	hwclock --systohc
}

pacman_do() {
	sed -i '33s/.//' /etc/pacman.conf
	sed -i -e '37s/.//' -e '37s/5/12/' /etc/pacman.conf
	sed -i '93,94s/.//' /etc/pacman.conf
	pacman --noconfirm -Sy wget git zsh exa zsh-syntax-highlighting 
	git clone https://aur.archlinux.org/paru-bin.git /usr/src/paru-bin && chmod 777 /usr/src/paru-bin
}

artix_archlinux_support_do() {
	pacman --noconfirm -Sy artix-archlinux-support
	echo -e "\n[extra]\nInclude = /etc/pacman.d/mirrorlist-arch" >> /etc/pacman.conf
	echo -e "\n[community]\nInclude = /etc/pacman.d/mirrorlist-arch" >> /etc/pacman.conf
	echo -e "\n[multilib]\nInclude = /etc/pacman.d/mirrorlist-arch" >> /etc/pacman.conf
}

uuid_root=$(blkid -o value -s UUID $ROOT)
systemd_boot_install(){
	bootctl install
	cat <<EOF > /boot/loader/entries/arch.conf
title   Arch Linux
linux   /vmlinuz-linux
initrd  /initramfs-linux.img
options rw root=UUID=$uuid_root nowatchdog loglevel=5
EOF
	echo -e "timeout 5\nconsole-mode max" > /boot/loader/loader.conf
}

arch_useradd(){
	sed -i '82s/. //' /etc/sudoers
	useradd -mG wheel,audio,video,kvm,storage -s /bin/zsh wael
	passwd && passwd wael
}

systemd_autologin(){ 
	mkdir /etc/systemd/system/getty@tty1.service.d
	echo -e "[Service]\nExecStart=\nExecStart=-/usr/bin/agetty --noissue --autologin wael --noclear %I \$TERM" > /etc/systemd/system/getty@tty1.service.d/override.conf
}

arch_reflector(){
	pacman --noconfirm -Sy reflector
	mkdir -pv /etc/xdg/reflector
	cat <<EOF > /etc/xdg/reflector/reflector.conf
--save /etc/pacman.d/mirrorlist
--latest 5
--sort rate
EOF
	systemctl enable reflector.service
}

# - VOID ---------------
void_strap(){
	XBPS_ARCH=x86_64
	REPO=https://alpha.de.repo.voidlinux.org/current
	XBPS_ARCH=$ARCH xbps-install -Sy -r /mnt -R $REPO base-system base-devel btrfs-progs grub-x86_64-efi socklog-void
}

void_needed(){
	echo LANG=en_US.UTF-8 > /mnt/etc/locale.conf
	echo "en_US.UTF-8 UTF-8" >> /mnt/etc/default/libc-locales
	echo $HOSTNAME > /mnt/etc/hostname
	cat <<EOF > /mnt/etc/rc.conf
HOSTNAME="$HOSTNAME"
HARDWARECLOCK="UTC"
TIMEZONE="Asia/Riyadh"
KEYMAP="us"
EOF
	./genfstab -U /mnt >> /mnt/etc/fstab
	chroot /mnt xbps-reconfigure -f glibc-locales
}

# - CHROOT LINE
xbps_do(){
	xbps-install -Syu void-repo-nonfree void-repo-multilib void-repo-multilib-nonfree
	xbps-install -Sy intel-ucode zsh zsh-syntax-highlighting wget git
}

void_sv_do(){
	ln -sv /etc/sv/dbus /etc/runit/runsvdir/default
	ln -sv /etc/sv/nanoklogd /etc/runit/runsvdir/default
	ln -sv /etc/sv/socklog-unix /etc/runit/runsvdir/default
}

void_useradd(){
	sed -i '82s/.//' /etc/sudoers
	useradd -m -G wheel,input,audio,video,kvm,storage,socklog -s /bin/zsh wael
	passwd wael && passwd
}

void_autologin(){ sed -i "/GETTY_ARGS=/s/\"$/ --autologin wael&/" /etc/sv/agetty-tty1/conf; }

# - POST INSTALL
post_install_goodbye(){
	rm /mods
	rm /post.sh
	echo "your install is done now go outside"
}

