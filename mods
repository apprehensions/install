# - UNIVERSAL -----------

# - make the partitions specified by enviroment variables
mkfs_part() {
  	mkfs.vfat -nBOOP -F32 $ESP
  	mkfs.btrfs -L root -f $ROOT
	mount -o $BTRFS_OPTS $ROOT /mnt
	btrfs subvolume create /mnt/@
	btrfs subvolume set-default /mnt/@
	umount /mnt
	mount -o $BTRFS_OPTS,subvol=@ $ROOT /mnt
}

# - CHROOT - install grub with 2 extra flags
grub_install(){
	grub-install --target=x86_64-efi --efi-directory=/efi --bootloader-id='Linux'
	sed -i "/GRUB_CMDLINE_LINUX_DEFAULT=/s/\"$/ nowatchdog loglevel=5&/" /etc/default/grub
	echo -e "\nGRUB_DISABLE_OS_PROBER=false" >> /etc/default/grub
	grub-mkconfig -o /boot/grub/grub.cfg
}

# - ARCH-BASED ----------

# - set /etc/hosts
hosts_do(){
	echo "127.0.0.1 localhost" >> /mnt/etc/hosts
	echo "::1       localhost" >> /mnt/etc/hosts 
	echo "127.0.1.1 $HOSTNAME.localdomain $HOSTNAME" >> /mnt/etc/hosts
}

# - set resolv.conf
resolv_do(){
	echo -e "nameserver 1.1.1.1\nnameserver 1.0.0.1" >> /mnt/etc/resolv.conf
	echo -e "nameserver 2606:4700:4700::1111\nnameserver 2606:4700:4700::1001" >> /mnt/etc/resolv.conf
}

# - CHROOT - make me with 5 groups
a_make_me(){
	sed -i '82s/. //' /etc/sudoers
	useradd -mG wheel,audio,video,kvm,storage -s /bin/zsh wael
	passwd && passwd wael
}

# - CHROOT - set locale,hostname,timezone 
a_needed() {
	echo "LANG=en_US.UTF-8" > /etc/locale.conf
	echo "en_US.UTF-8 UTF-8" > /etc/locale.gen
	echo $HOSTNAME > /etc/hostname
	ln -sf /usr/share/zoneinfo/Asia/Riyadh /etc/localtime
	hwclock --systohc
}

# - CHROOT - enable {colors,parallel,multilib} & install tools + aur helper
pacman_do() {
	sed -i '33s/.//' /etc/pacman.conf
	sed -i -e '37s/.//' -e '37s/5/12/' /etc/pacman.conf
	sed -i '93,94s/.//' /etc/pacman.conf
	pacman --noconfirm -Sy wget git zsh exa zsh-syntax-highlighting 
	git clone https://aur.archlinux.org/paru-bin.git /usr/src/paru-bin && chmod 777 /usr/src/paru-bin
}

# - CHROOT - well get arch repos
artix_archlinux_support_do() {
	pacman --noconfirm -Sy artix-archlinux-support
	echo -e "\n[extra]\nInclude = /etc/pacman.d/mirrorlist-arch" >> /etc/pacman.conf
	echo -e "\n[community]\nInclude = /etc/pacman.d/mirrorlist-arch" >> /etc/pacman.conf
	echo -e "\n[multilib]\nInclude = /etc/pacman.d/mirrorlist-arch" >> /etc/pacman.conf
}


# - CHROOT - i don't know but its just to set KMS for i915
i915_do(){
	sed -i '7s/()/(i915)/' /etc/mkinitcpio.conf
}



# - CHROOT - UNUSED - install systemd-boot
systemd-boot_install(){
	echo -e "title   Arch Linux\nlinux   /vmlinuz-linux\ninitrd  /initramfs-linux.img" > /boot/loader/entries/arch.conf
	echo "options rw root=UUID=$uuid_root nowatchdog loglevel=5" >> /boot/loader/entries/arch.conf
	echo -e "timeout 5\nconsole-mode max" > /boot/loader/loader.conf
}

# - VOID ---------------

# - STRAP - the pacstrap of void
void_strap(){
	XBPS_ARCH=x86_64
	REPO=https://alpha.de.repo.voidlinux.org/current
	XBPS_ARCH=$ARCH xbps-install -Sy -r /mnt -R $REPO base-system base-devel btrfs-progs grub-x86_64-efi socklog-unix
}

# - set locale,hostname,rc.conf,fstab
void_needed(){
	echo LANG=en_US.UTF-8 > /mnt/etc/locale.conf
	echo "en_US.UTF-8 UTF-8" >> /mnt/etc/default/libc-locales
	echo $HOSTNAME > /mnt/etc/hostname
	cat <<EOF > /mnt/etc/rc.conf
HOSTNAME="$HOSTNAME"
HARDWARECLOCK="UTC"
TIMEZONE="Asia/Riyadh"
KEYMAP="us"
EOF
	./genfstab -U /mnt >> /mnt/etc/fstab
	chroot /mnt xbps-reconfigure -f glibc-locales
}

# - CHROOT - get multilib-{nonfree},nonfree & install tools
xbps_do(){
	xbps-install -Syu void-repo-nonfree void-repo-multilib void-repo-multilib-nonfree
	xbps-install -Sy intel-ucode zsh zsh-syntax-highlighting wget git exa 
}

# - CHROOT - void services that are needed
void_sv_do(){
	ln -sv /etc/sv/dbus /etc/runit/runsvdir/default
	ln -sv /etc/sv/nanoklogd /etc/runit/runsvdir/default
	ln -sv /etc/sv/socklog-unix /etc/runit/runsvdir/default
}

# - CHROOT - make me with 7 groups for void for some reason
void_make_me(){
	sed -i '82s/.//' /etc/sudoers
	useradd -m -G wheel,input,audio,video,kvm,storage,socklog -s /bin/zsh wael
	passwd wael && passwd
}

# - AUTOLOGIN -----------
openrc_autologin(){ sed -i "agetty_options=/s/\"$/ --autologin wael --noclear&/" /etc/conf.d/agetty.tty1; }
arch_autologin(){ mkdir /etc/systemd/system/getty@tty1.service.d && echo -e "[Service]\nExecStart=\nExecStart=-/usr/bin/agetty --noissue --autologin wael --noclear" > /etc/systemd/system/getty@tty1.service.d/override.conf; }
void_autologin(){ sed -i "/GETTY_ARGS=/s/\"$/ --autologin wael&/" /etc/sv/agetty-tty1/conf; }
